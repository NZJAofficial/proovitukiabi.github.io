<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proovitükkide Arvutus</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .top-bar {
            background-color: #4CAF50;
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .top-button {
            padding: 10px 20px;
            background-color: #45a049;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        .top-button:hover {
            background-color: #3d8b40;
        }
        .container {
            width: 80%;
            margin: 0 auto;
            max-width: 1000px;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        h2, h3 {
            color: #333;
            margin-left: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        label {
            margin: 10px 0;
            font-weight: bold;
            display: block;
        }
        input[type="text"], input[type="number"], input[type="date"], select {
            padding: 8px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            max-width: 300px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .input-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .scrollable-table {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 18px;
            display: none;
            z-index: 1000;
        }
        .active-work {
            background-color: #fffde7;
        }
        .work-session-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .gps-container {
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .map-container {
            height: 300px;
            margin-top: 15px;
            border: 1px solid #ddd;
            position: relative;
            display: none;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .map-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .coordinates-display {
            margin-top: 10px;
            font-size: 14px;
        }
        .summary-row {
            font-weight: bold;
            background-color: #e6f7ff;
        }
    </style>
</head>
<body>
    <div class="timer-container" id="timerContainer">
        <div>Tööaeg: <span id="timerDisplay">00:00:00</span></div>
        <button id="stopWorkButton" style="margin-top: 10px; width: 100%;">Lõpeta töö</button>
    </div>

    <div class="top-bar">
        <button class="top-button" onclick="location.href='index.html'">Proovitükkide arvutus</button>
        <button class="top-button" onclick="location.href='istutamine.html'">Istutamise kalkulaator</button>
    </div>

    <div class="container" id="mainContainer">
        <h2>Proovitükkide arvutus</h2>
        
        <div class="input-group">
            <label for="langiNumber">Langi number:</label>
            <input type="text" id="langiNumber">
            
            <button id="startWorkButton" onclick="alustaTood()">Alusta töötegemist</button>
            <div id="workInfo" style="display: none; margin-top: 10px;">
                <p>Töö käib: <span id="currentLangNumber"></span></p>
                <div class="gps-container">
                    <h4>Asukoha märkimine</h4>
                    <button onclick="näitaKaarti()">Ava kaart</button>
                    <button onclick="kasutaGPS()">Kasuta GPS-i</button>
                    <button onclick="kustutaAsukoht()">Eemalda asukoht</button>
                    
                    <div class="map-container" id="mapContainer">
                        <div id="map"></div>
                        <div class="map-marker"></div>
                    </div>
                    
                    <div class="coordinates-display">
                        <p>Valitud koordinaadid: <span id="selectedCoordinates">Määramata</span></p>
                        <p>Täpsus: <span id="accuracyInfo">-</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="input-group" id="workInputGroup" style="display: none;">
            <h3>Proovitükkide andmed</h3>
            <label for="kuupaev">Kuupäev:</label>
            <input type="date" id="kuupaev">
            
            <label for="raadius">Proovitüki raadius (m):</label>
            <input type="number" id="raadius" step="0.01" min="0">
            
            <label for="proovitukkideArv">Proovitükkide arv:</label>
            <select id="proovitukkideArv" onchange="muudaProovitukkideVäljad()">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
            
            <div id="proovitukkideVäljad">
                <label for="proovitukk1">Proovitükk 1 taime arv:</label>
                <input type="number" id="proovitukk1" min="0">
            </div>
            
            <button onclick="lisaProovitukk()">Lisa proovitükk</button>
        </div>

        <h3>Proovitükkide andmed</h3>
        <div class="scrollable-table">
            <table id="proovitukkideTabel">
                <thead>
                    <tr>
                        <th>Langi number</th>
                        <th>Proovitüki raadius (m)</th>
                        <th>Proovitüki pindala (m²)</th>
                        <th>Proovitükkide taime arv</th>
                        <th>Proovitükkide arv hektaril</th>
                        <th>Kuupäev</th>
                        <th>Koordinaadid</th>
                        <th>Tööaeg</th>
                        <th>Tegevused</th>
                    </tr>
                </thead>
                <tbody id="proovitukkideSisu"></tbody>
            </table>
        </div>
        
        <button onclick="laadiAndmedTxtFailina()">Laadi andmed alla</button>
        <button onclick="kustutaAndmed()">Kustuta andmed</button>
    </div>

    <script>
        // Muutujad tööaja jälgimiseks
        let startTime;
        let timerInterval;
        let currentLangNumber = "";
        let currentWorkSessionId = "";
        let currentGPS = null;
        let currentProovitukid = [];
        let map;
        let marker;
        let clickListener;
        
        // Funktsioon, mis muudab proovitükkide sisestusväljad
        function muudaProovitukkideVäljad() {
            let proovitukkideArv = document.getElementById("proovitukkideArv").value;
            let proovitukkideVäljad = document.getElementById("proovitukkideVäljad");
            proovitukkideVäljad.innerHTML = '';

            for (let i = 1; i <= proovitukkideArv; i++) {
                let uusVäli = document.createElement('div');
                uusVäli.innerHTML = `
                    <label for="proovitukk${i}">Proovitükk ${i} taime arv:</label>
                    <input type="number" id="proovitukk${i}" min="0">
                `;
                proovitukkideVäljad.appendChild(uusVäli);
            }
        }
        
        // Alustame tööd
        function alustaTood() {
            const langiNumber = document.getElementById("langiNumber").value;
            
            if (!langiNumber) {
                alert("Palun sisesta langi number!");
                return;
            }
            
            currentLangNumber = langiNumber;
            currentWorkSessionId = Date.now().toString();
            currentProovitukid = [];
            currentGPS = null;
            
            // Aktiveerime töörežiimi
            document.getElementById("startWorkButton").disabled = true;
            document.getElementById("langiNumber").disabled = true;
            document.getElementById("workInputGroup").style.display = "block";
            document.getElementById("workInfo").style.display = "block";
            document.getElementById("currentLangNumber").textContent = langiNumber;
            document.getElementById("mainContainer").classList.add("active-work");
            document.getElementById("selectedCoordinates").textContent = "Määramata";
            document.getElementById("accuracyInfo").textContent = "-";
            
            // Määrame tänase kuupäeva
            document.getElementById("kuupaev").value = new Date().toISOString().slice(0, 10);
            
            // Käivitame ajastaja
            startTime = new Date();
            document.getElementById("timerContainer").style.display = "block";
            käivitaAjastaja();
        }
        
        // Käivitame ajastaja
        function käivitaAjastaja() {
            timerInterval = setInterval(function() {
                const currentTime = new Date();
                const timeDiff = currentTime - startTime;
                
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                document.getElementById("timerDisplay").textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            
            // Seadistame töö lõpetamise nupu
            document.getElementById("stopWorkButton").onclick = lõpetaTöö;
        }
        
        // Näita kaarti asukoha valimiseks
        function näitaKaarti() {
            const mapContainer = document.getElementById("mapContainer");
            mapContainer.style.display = "block";
            
            if (!map) {
                // Loome uue kaardi keskpunktiga Eesti
                map = L.map('map').setView([58.5953, 25.0136], 7);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Lisame markeri
                marker = L.marker([58.5953, 25.0136], {
                    draggable: true,
                    autoPan: true
                }).addTo(map);
                
                // Kuulame markeri liigutamist
                marker.on('move', function(e) {
                    const latlng = marker.getLatLng();
                    currentGPS = {
                        latitude: latlng.lat,
                        longitude: latlng.lng,
                        accuracy: 10 // Eeldame 10m täpsust käsitsi märkimisel
                    };
                    uuendaKoordinaatideKuvamine();
                });
                
                // Kuulame kaardil klikkimist
                clickListener = map.on('click', function(e) {
                    marker.setLatLng(e.latlng);
                    currentGPS = {
                        latitude: e.latlng.lat,
                        longitude: e.latlng.lng,
                        accuracy: 10 // Eeldame 10m täpsust käsitsi märkimisel
                    };
                    uuendaKoordinaatideKuvamine();
                });
            }
        }
        
        // Kasuta GPS-i asukoha määramiseks
        function kasutaGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentGPS = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        // Näita kaarti ja keskenda valitud asukohale
                        näitaKaarti();
                        map.setView([currentGPS.latitude, currentGPS.longitude], 16);
                        marker.setLatLng([currentGPS.latitude, currentGPS.longitude]);
                        
                        uuendaKoordinaatideKuvamine();
                    },
                    function(error) {
                        alert("GPS asukoha määramine ebaõnnestus: " + error.message);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("Teie brauser ei toeta geolokatsiooni!");
            }
        }
        
        // Kustuta asukoht
        function kustutaAsukoht() {
            currentGPS = null;
            document.getElementById("selectedCoordinates").textContent = "Määramata";
            document.getElementById("accuracyInfo").textContent = "-";
            document.getElementById("mapContainer").style.display = "none";
        }
        
        // Uuenda koordinaatide kuvamist
        function uuendaKoordinaatideKuvamine() {
            if (currentGPS) {
                document.getElementById("selectedCoordinates").textContent = 
                    `${currentGPS.latitude.toFixed(6)}, ${currentGPS.longitude.toFixed(6)}`;
                document.getElementById("accuracyInfo").textContent = 
                    `±${Math.round(currentGPS.accuracy)} meetrit`;
            } else {
                document.getElementById("selectedCoordinates").textContent = "Määramata";
                document.getElementById("accuracyInfo").textContent = "-";
            }
        }
        
        // Lisame proovitüki andmed
        function lisaProovitukk() {
            const kuupaev = document.getElementById("kuupaev").value;
            const raadius = parseFloat(document.getElementById("raadius").value);
            const proovitukkideArv = document.getElementById("proovitukkideArv").value;

            if (!kuupaev || isNaN(raadius) || raadius <= 0) {
                alert("Palun täida kõik väljad korrektselt!");
                return;
            }

            let proovitukkideArvudeSeeria = [];
            for (let i = 1; i <= proovitukkideArv; i++) {
                let proovitukk = parseInt(document.getElementById(`proovitukk${i}`).value);
                if (isNaN(proovitukk) || proovitukk < 0) {
                    alert("Palun sisesta kõik proovitükkide taime arvud korrektselt!");
                    return;
                }
                proovitukkideArvudeSeeria.push(proovitukk);
            }

            let pindala = Math.PI * Math.pow(raadius, 2);
            let proovitukkideArvHektaril = proovitukkideArvudeSeeria.reduce((sum, val) => sum + val, 0) / proovitukkideArv / pindala * 10000;
            
            // Lisame proovitüki andmed hetkel töös oleva langi alla
            currentProovitukid.push({
                kuupaev,
                raadius,
                pindala,
                proovitukkideArvudeSeeria,
                proovitukkideArvHektaril,
                gps: currentGPS ? {...currentGPS} : null
            });
            
            // Uuendame tabelit
            uuendaTabel();
            
            // Tühjendame väljad (v.a langi number ja GPS)
            document.getElementById("raadius").value = "";
            for (let i = 1; i <= proovitukkideArv; i++) {
                document.getElementById(`proovitukk${i}`).value = "";
            }
        }
        
        // Lõpetame töö ja salvestame andmed
        function lõpetaTöö() {
            clearInterval(timerInterval);
            document.getElementById("timerContainer").style.display = "none";
            
            const endTime = new Date();
            const timeDiff = endTime - startTime;
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            const tööaeg = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Arvutame kogu taimede arvu ja keskmise hektaril
            let kokkuTaimed = 0;
            let keskmineArvHektaril = 0;
            let kokkuPindala = 0;
            
            currentProovitukid.forEach(proovitukk => {
                kokkuTaimed += proovitukk.proovitukkideArvudeSeeria.reduce((sum, val) => sum + val, 0);
                keskmineArvHektaril += proovitukk.proovitukkideArvHektaril;
                kokkuPindala += proovitukk.pindala;
            });
            
            if (currentProovitukid.length > 0) {
                keskmineArvHektaril = keskmineArvHektaril / currentProovitukid.length;
                
                let andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
                
                // Lisame kokkuvõtva kirje
                andmed.push({
                    langiNumber: currentLangNumber,
                    kuupaev: currentProovitukid[0].kuupaev, // Võtame esimese proovitüki kuupäeva
                    raadius: null, // Kokkuvõttes pole raadiust
                    pindala: kokkuPindala,
                    proovitukkideArvudeSeeria: [kokkuTaimed],
                    proovitukkideArvHektaril: keskmineArvHektaril,
                    gps: currentProovitukid.length > 0 ? currentProovitukid[0].gps : null, // Võtame esimese proovitüki asukoha
                    tööaeg: tööaeg,
                    isSummary: true, // Märgime kokkuvõtva kirjena
                    workSessionId: currentWorkSessionId,
                    details: [...currentProovitukid] // Salvestame ka detailid
                });
                
                // Lisame ka kõik üksikud proovitükid
                currentProovitukid.forEach(proovitukk => {
                    andmed.push({
                        langiNumber: currentLangNumber,
                        kuupaev: proovitukk.kuupaev,
                        raadius: proovitukk.raadius,
                        pindala: proovitukk.pindala,
                        proovitukkideArvudeSeeria: proovitukk.proovitukkideArvudeSeeria,
                        proovitukkideArvHektaril: proovitukk.proovitukkideArvHektaril,
                        gps: proovitukk.gps,
                        tööaeg: tööaeg,
                        isSummary: false,
                        workSessionId: currentWorkSessionId
                    });
                });
                
                localStorage.setItem("proovitukid", JSON.stringify(andmed));
            }
            
            // Lähtestame töörežiimi
            document.getElementById("startWorkButton").disabled = false;
            document.getElementById("langiNumber").disabled = false;
            document.getElementById("workInputGroup").style.display = "none";
            document.getElementById("workInfo").style.display = "none";
            document.getElementById("mainContainer").classList.remove("active-work");
            document.getElementById("mapContainer").style.display = "none";
            
            // Tühjendame väljad
            document.getElementById("langiNumber").value = "";
            currentGPS = null;
            currentProovitukid = [];
            
            // Uuendame tabelit
            uuendaTabel();
        }
        
        // Uuendame tabeli andmetega
        function uuendaTabel() {
            const tabel = document.getElementById("proovitukkideSisu");
            tabel.innerHTML = "";
            
            let andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
            
            // Grupeerime andmed langi numbri ja tööseansi järgi
            let groupedData = {};
            andmed.forEach(item => {
                if (!item.workSessionId) return;
                
                if (!groupedData[item.workSessionId]) {
                    groupedData[item.workSessionId] = {
                        langiNumber: item.langiNumber,
                        items: [],
                        summary: null
                    };
                }
                
                if (item.isSummary) {
                    groupedData[item.workSessionId].summary = item;
                } else {
                    groupedData[item.workSessionId].items.push(item);
                }
            });
            
            // Lisame töös olevad proovitükid (kui neid on)
            if (currentProovitukid.length > 0) {
                const rida = tabel.insertRow();
                rida.className = "summary-row";
                rida.innerHTML = `
                    <td>${currentLangNumber} (TÖÖS)</td>
                    <td>-</td>
                    <td>-</td>
                    <td>${currentProovitukid.reduce((sum, pt) => sum + pt.proovitukkideArvudeSeeria.reduce((s, v) => s + v, 0), 0)}</td>
                    <td>${(currentProovitukid.reduce((sum, pt) => sum + pt.proovitukkideArvHektaril, 0) / currentProovitukid.length).toFixed(2)}</td>
                    <td>${currentProovitukid[0]?.kuupaev || '-'}</td>
                    <td>${currentProovitukid[0]?.gps ? `${currentProovitukid[0].gps.latitude.toFixed(6)}, ${currentProovitukid[0].gps.longitude.toFixed(6)}` : 'Määramata'}</td>
                    <td>Töös</td>
                    <td></td>
                `;
                
                // Lisame detailread
                currentProovitukid.forEach((proovitukk, index) => {
                    const detailRida = tabel.insertRow();
                    const proovitukkideTaimeArv = proovitukk.proovitukkideArvudeSeeria.join(", ");
                    const gpsText = proovitukk.gps ? 
                        `${proovitukk.gps.latitude.toFixed(6)}, ${proovitukk.gps.longitude.toFixed(6)}` : 
                        "Määramata";
                    
                    detailRida.innerHTML = `
                        <td>${currentLangNumber}</td>
                        <td>${proovitukk.raadius.toFixed(2)}</td>
                        <td>${proovitukk.pindala.toFixed(2)}</td>
                        <td>${proovitukkideTaimeArv}</td>
                        <td>${proovitukk.proovitukkideArvHektaril.toFixed(2)}</td>
                        <td>${proovitukk.kuupaev}</td>
                        <td>${gpsText}</td>
                        <td>Töös</td>
                        <td>
                            <button onclick="kustutaProovitukk(${index})">Kustuta</button>
                        </td>
                    `;
                });
            }
            
            // Lisame salvestatud andmed
            Object.values(groupedData).forEach(group => {
                if (group.summary) {
                    const rida = tabel.insertRow();
                    rida.className = "summary-row";
                    const gpsText = group.summary.gps ? 
                        `${group.summary.gps.latitude.toFixed(6)}, ${group.summary.gps.longitude.toFixed(6)}` : 
                        "Määramata";
                    
                    rida.innerHTML = `
                        <td>${group.summary.langiNumber}</td>
                        <td>-</td>
                        <td>${group.summary.pindala.toFixed(2)}</td>
                        <td>${group.summary.proovitukkideArvudeSeeria[0]}</td>
                        <td>${group.summary.proovitukkideArvHektaril.toFixed(2)}</td>
                        <td>${group.summary.kuupaev}</td>
                        <td>${gpsText}</td>
                        <td>${group.summary.tööaeg}</td>
                        <td>
                            <button onclick="kustutaTööSeanss('${group.summary.workSessionId}')">Kustuta kogu töö</button>
                        </td>
                    `;
                    
                    // Lisame detailread
                    group.items.forEach(item => {
                        const detailRida = tabel.insertRow();
                        const proovitukkideTaimeArv = item.proovitukkideArvudeSeeria.join(", ");
                        const gpsText = item.gps ? 
                            `${item.gps.latitude.toFixed(6)}, ${item.gps.longitude.toFixed(6)}` : 
                            "Määramata";
                        
                        detailRida.innerHTML = `
                            <td>${item.langiNumber}</td>
                            <td>${item.raadius.toFixed(2)}</td>
                            <td>${item.pindala.toFixed(2)}</td>
                            <td>${proovitukkideTaimeArv}</td>
                            <td>${item.proovitukkideArvHektaril.toFixed(2)}</td>
                            <td>${item.kuupaev}</td>
                            <td>${gpsText}</td>
                            <td>${item.tööaeg}</td>
                            <td>
                                <button onclick="kustutaSalvestatudProovitukk('${item.workSessionId}', ${item.isSummary ? 'true' : 'false'})">Kustuta</button>
                            </td>
                        `;
                    });
                }
            });
        }
        
        // Kustuta töös olev proovitükk
        function kustutaProovitukk(index) {
            if (confirm("Kas oled kindel, et soovid selle proovitüki kustutada?")) {
                currentProovitukid.splice(index, 1);
                uuendaTabel();
            }
        }
        
        // Kustuta kogu tööseanss
        function kustutaTööSeanss(workSessionId) {
            if (confirm("Kas oled kindel, et soovid kogu selle tööseansi andmed kustutada?")) {
                let andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
                andmed = andmed.filter(item => item.workSessionId !== workSessionId);
                localStorage.setItem("proovitukid", JSON.stringify(andmed));
                uuendaTabel();
            }
        }
        
        // Kustuta salvestatud proovitükk
        function kustutaSalvestatudProovitukk(workSessionId, isSummary) {
            if (confirm("Kas oled kindel, et soovid selle proovitüki kustutada?")) {
                let andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
                
                if (isSummary) {
                    // Kustutame kogu tööseansi
                    andmed = andmed.filter(item => item.workSessionId !== workSessionId);
                } else {
                    // Kustutame üksiku proovitüki
                    const summaryIndex = andmed.findIndex(item => item.workSessionId === workSessionId && item.isSummary);
                    
                    if (summaryIndex !== -1) {
                        // Uuendame kokkuvõtet
                        const itemsInSession = andmed.filter(item => 
                            item.workSessionId === workSessionId && !item.isSummary
                        );
                        
                        if (itemsInSession.length <= 1) {
                            // Kui jääb ainult üks proovitükk, kustutame kogu seansi
                            andmed = andmed.filter(item => item.workSessionId !== workSessionId);
                        } else {
                            // Arvutame uued kogusummad
                            let kokkuTaimed = 0;
                            let keskmineArvHektaril = 0;
                            let kokkuPindala = 0;
                            
                            itemsInSession.forEach(item => {
                                if (item.workSessionId === workSessionId && !item.isSummary) {
                                    kokkuTaimed += item.proovitukkideArvudeSeeria.reduce((sum, val) => sum + val, 0);
                                    keskmineArvHektaril += item.proovitukkideArvHektaril;
                                    kokkuPindala += item.pindala;
                                }
                            });
                            
                            keskmineArvHektaril = keskmineArvHektaril / itemsInSession.length;
                            
                            andmed[summaryIndex] = {
                                ...andmed[summaryIndex],
                                proovitukkideArvudeSeeria: [kokkuTaimed],
                                proovitukkideArvHektaril: keskmineArvHektaril,
                                pindala: kokkuPindala
                            };
                            
                            // Eemaldame konkreetse proovitüki
                            andmed = andmed.filter(item => 
                                !(item.workSessionId === workSessionId && !item.isSummary && 
                                  item.kuupaev === workSessionId) // Siin peaks olema mingi unikaalne ID kontroll
                            );
                        }
                    }
                }
                
                localStorage.setItem("proovitukid", JSON.stringify(andmed));
                uuendaTabel();
            }
        }
        
        // Laadi andmed alla tekstifailina
        function laadiAndmedTxtFailina() {
            let andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
            
            if (andmed.length === 0 && currentProovitukid.length === 0) {
                alert("Pole andmeid allalaadimiseks!");
                return;
            }
            
            let sisu = "Proovitükkide andmed\n\n";
            let koguPindala = 0;
            let keskmineArvHektaril = 0;
            let langideArv = new Set();
            
            // Grupeerime andmed tööseansside kaupa
            let groupedData = {};
            andmed.forEach(item => {
                if (!item.workSessionId) return;
                
                if (!groupedData[item.workSessionId]) {
                    groupedData[item.workSessionId] = {
                        summary: null,
                        items: []
                    };
                }
                
                if (item.isSummary) {
                    groupedData[item.workSessionId].summary = item;
                } else {
                    groupedData[item.workSessionId].items.push(item);
                }
            });
            
            // Lisame töös olevad proovitükid (kui neid on)
            if (currentProovitukid.length > 0) {
                const kokkuTaimed = currentProovitukid.reduce((sum, pt) => sum + pt.proovitukkideArvudeSeeria.reduce((s, v) => s + v, 0), 0);
                const keskmine = (currentProovitukid.reduce((sum, pt) => sum + pt.proovitukkideArvHektaril, 0) / currentProovitukid.length);
                const kokkuPindala = currentProovitukid.reduce((sum, pt) => sum + pt.pindala, 0);
                
                sisu += `=== TÖÖS OLEV TÖÖSEANSS ===\n`;
                sisu += `Langi number: ${currentLangNumber}\n`;
                sisu += `Kuupäev: ${currentProovitukid[0]?.kuupaev || '-'}\n`;
                sisu += `Kokku taimi: ${kokkuTaimed}\n`;
                sisu += `Keskmine taimede arv hektaril: ${keskmine.toFixed(2)}\n`;
                sisu += `Kokku pindala: ${kokkuPindala.toFixed(2)} m²\n`;
                sisu += `Asukoht: ${currentProovitukid[0]?.gps ? `${currentProovitukid[0].gps.latitude.toFixed(6)}, ${currentProovitukid[0].gps.longitude.toFixed(6)}` : 'Määramata'}\n`;
                sisu += `Tööaeg: Töös\n\n`;
                
                // Detailid
                currentProovitukid.forEach((proovitukk, index) => {
                    sisu += `Proovitükk ${index + 1}:\n`;
                    sisu += `  Raadius: ${proovitukk.raadius.toFixed(2)} m\n`;
                    sisu += `  Pindala: ${proovitukk.pindala.toFixed(2)} m²\n`;
                    sisu += `  Taimede arvud: ${proovitukk.proovitukkideArvudeSeeria.join(', ')}\n`;
                    sisu += `  Taimede arv hektaril: ${proovitukk.proovitukkideArvHektaril.toFixed(2)}\n`;
                    sisu += `  Asukoht: ${proovitukk.gps ? `${proovitukk.gps.latitude.toFixed(6)}, ${proovitukk.gps.longitude.toFixed(6)}` : 'Määramata'}\n\n`;
                });
                
                koguPindala += kokkuPindala;
                keskmineArvHektaril += keskmine * currentProovitukid.length;
                langideArv.add(currentLangNumber);
            }
            
            // Lisame salvestatud andmed
            Object.values(groupedData).forEach(group => {
                if (group.summary) {
                    sisu += `=== TÖÖSEANSS ${group.summary.workSessionId.slice(-6)} ===\n`;
                    sisu += `Langi number: ${group.summary.langiNumber}\n`;
                    sisu += `Kuupäev: ${group.summary.kuupaev}\n`;
                    sisu += `Kokku taimi: ${group.summary.proovitukkideArvudeSeeria[0]}\n`;
                    sisu += `Keskmine taimede arv hektaril: ${group.summary.proovitukkideArvHektaril.toFixed(2)}\n`;
                    sisu += `Kokku pindala: ${group.summary.pindala.toFixed(2)} m²\n`;
                    sisu += `Asukoht: ${group.summary.gps ? `${group.summary.gps.latitude.toFixed(6)}, ${group.summary.gps.longitude.toFixed(6)}` : 'Määramata'}\n`;
                    sisu += `Tööaeg: ${group.summary.tööaeg}\n\n`;
                    
                    // Detailid
                    group.items.forEach((item, index) => {
                        sisu += `Proovitükk ${index + 1}:\n`;
                        sisu += `  Raadius: ${item.raadius.toFixed(2)} m\n`;
                        sisu += `  Pindala: ${item.pindala.toFixed(2)} m²\n`;
                        sisu += `  Taimede arvud: ${item.proovitukkideArvudeSeeria.join(', ')}\n`;
                        sisu += `  Taimede arv hektaril: ${item.proovitukkideArvHektaril.toFixed(2)}\n`;
                        sisu += `  Asukoht: ${item.gps ? `${item.gps.latitude.toFixed(6)}, ${item.gps.longitude.toFixed(6)}` : 'Määramata'}\n\n`;
                    });
                    
                    koguPindala += group.summary.pindala;
                    keskmineArvHektaril += group.summary.proovitukkideArvHektaril * group.items.length;
                    langideArv.add(group.summary.langiNumber);
                }
            });
            
            if (langideArv.size > 0) {
                keskmineArvHektaril = keskmineArvHektaril / (currentProovitukid.length + andmed.filter(item => !item.isSummary).length);
                
                sisu += `KOKKUVÕTE:\n`;
                sisu += `Kokku langisid: ${langideArv.size}\n`;
                sisu += `Kokku proovitükke: ${currentProovitukid.length + andmed.filter(item => !item.isSummary).length}\n`;
                sisu += `Kogu proovitükkide pindala: ${koguPindala.toFixed(2)} m²\n`;
                sisu += `Keskmine taimede arv hektaril: ${keskmineArvHektaril.toFixed(2)}\n`;
            }
            
            const blob = new Blob([sisu], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `proovitukkide_andmed_${new Date().toISOString().slice(0,10)}.txt`;
            link.click();
        }
        
        // Kustuta kõik andmed
        function kustutaAndmed() {
            if (confirm("Kas oled kindel, et soovid kõik andmed kustutada?")) {
                localStorage.removeItem("proovitukid");
                currentProovitukid = [];
                uuendaTabel();
            }
        }
        
        // Laadime salvestatud andmed lehe avamisel
        window.onload = function() {
            // Määra tänane kuupäev vaikeväärtuseks
            document.getElementById("kuupaev").value = new Date().toISOString().slice(0, 10);
            
            // Kontrollime, kas on pooleliolevaid töid
            const andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
            const pooleliolevTöö = andmed.find(item => item.workSessionId && !item.isSummary);
            
            if (pooleliolevTöö) {
                // Taastame poolelioleva töö
                currentLangNumber = pooleliolevTöö.langiNumber;
                currentWorkSessionId = pooleliolevTöö.workSessionId;
                startTime = new Date(pooleliolevTöö.startTime);
                
                // Aktiveerime töörežiimi
                document.getElementById("startWorkButton").disabled = true;
                document.getElementById("langiNumber").disabled = true;
                document.getElementById("workInputGroup").style.display = "block";
                document.getElementById("workInfo").style.display = "block";
                document.getElementById("currentLangNumber").textContent = currentLangNumber;
                document.getElementById("mainContainer").classList.add("active-work");
                
                // Käivitame ajastaja
                document.getElementById("timerContainer").style.display = "block";
                käivitaAjastaja();
            }
            
            uuendaTabel();
            
            // Laadime OpenStreetMap'i raamistiku
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.js';
            script.onload = function() {
                // CSS on juba lisatud
                console.log('Leaflet loaded');
            };
            document.head.appendChild(script);
            
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.css';
            document.head.appendChild(link);
        };
    </script>
</body>
</html>
