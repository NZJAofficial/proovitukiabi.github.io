<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proovitükkide Arvutus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #map {
            height: 500px;
            margin-top: 20px;
            border-radius: 8px;
        }
        .button-group {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .gps-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .gps-active {
            background-color: #2ecc71;
            color: white;
        }
        .gps-inactive {
            background-color: #e74c3c;
            color: white;
        }
        .active-work {
            border-left: 5px solid #27ae60;
            padding-left: 15px;
        }
        .proovitukk-marker {
            background-color: red;
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .langi-marker {
            background-color: blue;
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .user-marker {
            background-color: green;
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <h1>Proovitükkide Arvutus</h1>
        
        <div class="button-group">
            <button id="startWorkButton" onclick="alustaTööd()">Alusta uut tööd</button>
            <input type="text" id="langiNumber" placeholder="Langi number">
            <button onclick="lõpetaTöö()">Lõpeta töö</button>
            <button id="toggleGpsButton" onclick="toggleGps()">Käivita GPS jälgimine</button>
            <span id="gpsStatusText" class="gps-status gps-inactive">MITTEAKTIIVNE</span>
        </div>
        
        <div id="workInputGroup" style="display: none;">
            <h2>Töö käimas: Langi <span id="currentLangNumber"></span></h2>
            <div id="timerContainer" style="display: none;">
                <p>Tööaeg: <span id="timer">00:00:00</span></p>
            </div>
            <div id="workInfo" style="display: none;">
                <input type="date" id="kuupaev">
                <input type="number" id="raadius" placeholder="Raadius (m)" step="0.01">
                <input type="number" id="taimeArv" placeholder="Taimede arv">
                <button onclick="lisaProovitükk()">Lisa proovitükk</button>
                <p id="currentLocation">Praegune asukoht: ootan GPS andmeid...</p>
            </div>
        </div>
        
        <div class="button-group">
            <button onclick="laadiAndmedTxtFailina()">Laadi andmed alla</button>
            <button onclick="kustutaAndmed()">Kustuta kõik andmed</button>
            <button onclick="naitaKaardil()">Näita kõiki proovitükke kaardil</button>
            <button onclick="varjakaart()">Peida kaart</button>
        </div>
        
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Globaalsed muutujad
        let currentLangNumber = "";
        let currentProovitukid = [];
        let watchId = null;
        let currentPosition = null;
        let map;
        let proovitukkMarker = null;
        let langiMarker = null;
        let userMarker = null; // Kasutaja asukoha marker
        let allMarkers = [];
        let startTime;
        let timerInterval;
        let currentWorkSessionId = Date.now().toString();

        // Kaardi initsialiseerimine
        function initMap() {
            if (!map) {
                map = L.map('map').setView([58.5953, 25.0136], 7);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }
        }

        // Alusta uut tööd
        function alustaTööd() {
            const langiNr = document.getElementById("langiNumber").value.trim();
            if (!langiNr) {
                alert("Palun sisesta langi number!");
                return;
            }
            
            currentLangNumber = langiNr;
            currentWorkSessionId = Date.now().toString();
            startTime = new Date();
            
            document.getElementById("startWorkButton").disabled = true;
            document.getElementById("langiNumber").disabled = true;
            document.getElementById("workInputGroup").style.display = "block";
            document.getElementById("workInfo").style.display = "block";
            document.getElementById("currentLangNumber").textContent = currentLangNumber;
            document.getElementById("timerContainer").style.display = "block";
            document.getElementById("mainContainer").classList.add("active-work");
            
            käivitaAjastaja();
            initMap();
        }

        // Lisa proovitükk
        function lisaProovitükk() {
            const kuupaev = document.getElementById("kuupaev").value;
            const raadius = parseFloat(document.getElementById("raadius").value);
            const taimeArv = parseInt(document.getElementById("taimeArv").value);
            
            if (!kuupaev || isNaN(raadius) || isNaN(taimeArv)) {
                alert("Palun täida kõik väljad korrektselt!");
                return;
            }
            
            if (!currentPosition) {
                alert("GPS asukoht pole saadaval! Ootame GPS andmeid...");
                return;
            }
            
            const pindala = Math.PI * Math.pow(raadius, 2);
            const taimedeArvHektaril = taimeArv / (pindala / 10000);
            
            const langiGps = currentProovitukid.length === 0 ? currentPosition : null;
            
            const proovitukk = {
                kuupaev: kuupaev,
                raadius: raadius,
                pindala: pindala,
                taimeArv: taimeArv,
                taimedeArvHektaril: taimedeArvHektaril,
                gps: currentPosition,
                langiGps: langiGps
            };
            
            currentProovitukid.push(proovitukk);
            
            // Lisa marker kaardile
            lisaMarkerKaardile(proovitukk, currentProovitukid.length);
            
            document.getElementById("raadius").value = "";
            document.getElementById("taimeArv").value = "";
            
            alert(`Proovitükk ${currentProovitukid.length} lisatud!`);
        }

        // Lisa marker kaardile
        function lisaMarkerKaardile(proovitukk, index) {
            if (proovitukkMarker) {
                map.removeLayer(proovitukkMarker);
            }
            
            // Lisa proovitüki marker
            proovitukkMarker = L.marker(
                [proovitukk.gps.latitude, proovitukk.gps.longitude],
                {
                    icon: L.divIcon({
                        className: 'proovitukk-marker',
                        html: '<div style="background-color: red; width: 20px; height: 20px; border-radius: 50%;"></div>',
                        iconSize: [20, 20]
                    })
                }
            ).addTo(map);
            
            proovitukkMarker.bindPopup(`
                <b>Proovitükk ${index}</b><br>
                Langi ${currentLangNumber}<br>
                Raadius: ${proovitukk.raadius.toFixed(2)} m<br>
                Taimi: ${proovitukk.taimeArv}<br>
                Taimi/ha: ${proovitukk.taimedeArvHektaril.toFixed(2)}
            `);
            
            allMarkers.push(proovitukkMarker);
            
            // Kui see on esimene proovitükk, lisa ka langi marker
            if (proovitukk.langiGps) {
                if (langiMarker) {
                    map.removeLayer(langiMarker);
                }
                
                langiMarker = L.marker(
                    [proovitukk.langiGps.latitude, proovitukk.langiGps.longitude],
                    {
                        icon: L.divIcon({
                            className: 'langi-marker',
                            html: '<div style="background-color: blue; width: 20px; height: 20px; border-radius: 50%;"></div>',
                            iconSize: [20, 20]
                        })
                    }
                ).addTo(map);
                
                langiMarker.bindPopup(`<b>Langi ${currentLangNumber}</b><br>Asukoht`);
                allMarkers.push(langiMarker);
            }
            
            // Keskenda kaart kõikidele markeritele
            const bounds = new L.LatLngBounds();
            allMarkers.forEach(marker => {
                bounds.extend(marker.getLatLng());
            });
            map.fitBounds(bounds);
        }

        // GPS jälgimise lülitamine
        function toggleGps() {
            if (watchId) {
                // Peata jälgimine
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                document.getElementById("toggleGpsButton").textContent = "Käivita GPS jälgimine";
                document.getElementById("gpsStatusText").textContent = "MITTEAKTIIVNE";
                document.getElementById("gpsStatusText").className = "gps-status gps-inactive";
                document.getElementById("currentLocation").textContent = "GPS jälgimine peatatud";
                
                // Eemalda kasutaja marker
                if (userMarker) {
                    map.removeLayer(userMarker);
                    userMarker = null;
                }
            } else {
                // Käivita jälgimine
                if (navigator.geolocation) {
                    document.getElementById("toggleGpsButton").textContent = "Peata GPS jälgimine";
                    document.getElementById("gpsStatusText").textContent = "AKTIIVNE";
                    document.getElementById("gpsStatusText").className = "gps-status gps-active";
                    
                    // Käivita geolokatsiooni jälgimine
                    watchId = navigator.geolocation.watchPosition(
                        position => {
                            // Uuenda kasutaja asukohta
                            currentPosition = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            
                            // Uuenda teksti
                            document.getElementById("currentLocation").textContent = 
                                `Asukoht: ${currentPosition.latitude.toFixed(6)}, ${currentPosition.longitude.toFixed(6)} (täpsus: ${currentPosition.accuracy.toFixed(0)} m)`;
                            
                            // Uuenda kaarti
                            if (map) {
                                // Eemalda vana kasutaja marker
                                if (userMarker) {
                                    map.removeLayer(userMarker);
                                }
                                
                                // Lisa uus kasutaja marker
                                userMarker = L.marker(
                                    [currentPosition.latitude, currentPosition.longitude],
                                    {
                                        icon: L.divIcon({
                                            className: 'user-marker',
                                            html: '<div style="background-color: green; width: 20px; height: 20px; border-radius: 50%;"></div>',
                                            iconSize: [20, 20]
                                        })
                                    }
                                ).addTo(map);
                                
                                userMarker.bindPopup(`<b>Sinu asukoht</b><br>${currentPosition.latitude.toFixed(6)}, ${currentPosition.longitude.toFixed(6)}`);
                                
                                // Keskenda kaart kasutaja asukohale (ainult esimest korda)
                                if (!proovitukkMarker) {
                                    map.setView([currentPosition.latitude, currentPosition.longitude], 18);
                                }
                            }
                        },
                        error => {
                            console.error("GPS viga:", error);
                            document.getElementById("currentLocation").textContent = "GPS viga: " + error.message;
                        },
                        {
                            enableHighAccuracy: true,
                            maximumAge: 10000,
                            timeout: 5000
                        }
                    );
                } else {
                    alert("Teie brauser ei toeta geolokatsiooni!");
                }
            }
        }

        // Käivita ajastaja
        function käivitaAjastaja() {
            startTime = new Date();
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - startTime;
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById("timer").textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Lõpeta töö
        function lõpetaTöö() {
            clearInterval(timerInterval);
            
            const endTime = new Date();
            const timeDiff = endTime - startTime;
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            const tööaeg = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (currentProovitukid.length > 0) {
                let andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
                
                currentProovitukid.forEach(proovitukk => {
                    andmed.push({
                        langiNumber: currentLangNumber,
                        kuupaev: proovitukk.kuupaev,
                        raadius: proovitukk.raadius,
                        pindala: proovitukk.pindala,
                        taimeArv: proovitukk.taimeArv,
                        taimedeArvHektaril: proovitukk.taimedeArvHektaril,
                        gps: proovitukk.gps,
                        langiGps: proovitukk.langiGps,
                        tööaeg: tööaeg,
                        workSessionId: currentWorkSessionId
                    });
                });
                
                localStorage.setItem("proovitukid", JSON.stringify(andmed));
            }
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                document.getElementById("toggleGpsButton").textContent = "Käivita GPS jälgimine";
                document.getElementById("gpsStatusText").textContent = "MITTEAKTIIVNE";
                document.getElementById("gpsStatusText").className = "gps-status gps-inactive";
            }
            
            document.getElementById("startWorkButton").disabled = false;
            document.getElementById("langiNumber").disabled = false;
            document.getElementById("workInputGroup").style.display = "none";
            document.getElementById("workInfo").style.display = "none";
            document.getElementById("mainContainer").classList.remove("active-work");
            document.getElementById("langiNumber").value = "";
            currentProovitukid = [];
        }

        // Näita kõiki proovitükke kaardil
        function naitaKaardil() {
            let andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
            
            allMarkers.forEach(marker => map.removeLayer(marker));
            allMarkers = [];
            
            if (andmed.length === 0 && currentProovitukid.length === 0) {
                alert("Pole proovitükke kaardil kuvamiseks!");
                return;
            }
            
            initMap();
            
            let groupedData = {};
            andmed.forEach(item => {
                if (!groupedData[item.langiNumber]) {
                    groupedData[item.langiNumber] = [];
                }
                groupedData[item.langiNumber].push(item);
            });
            
            if (currentProovitukid.length > 0) {
                if (!groupedData[currentLangNumber]) {
                    groupedData[currentLangNumber] = [];
                }
                groupedData[currentLangNumber] = groupedData[currentLangNumber].concat(currentProovitukid);
            }
            
            Object.entries(groupedData).forEach(([langiNumber, proovitukid]) => {
                if (proovitukid[0].langiGps) {
                    const marker = L.marker(
                        [proovitukid[0].langiGps.latitude, proovitukid[0].langiGps.longitude],
                        {
                            icon: L.divIcon({
                                className: 'langi-marker',
                                html: '<div style="background-color: blue; width: 20px; height: 20px; border-radius: 50%;"></div>',
                                iconSize: [20, 20]
                            })
                        }
                    ).addTo(map);
                    marker.bindPopup(`<b>Langi ${langiNumber}</b><br>Asukoht`);
                    allMarkers.push(marker);
                }
                
                proovitukid.forEach((proovitukk, index) => {
                    if (proovitukk.gps) {
                        const marker = L.marker(
                            [proovitukk.gps.latitude, proovitukk.gps.longitude],
                            {
                                icon: L.divIcon({
                                    className: 'proovitukk-marker',
                                    html: '<div style="background-color: red; width: 20px; height: 20px; border-radius: 50%;"></div>',
                                    iconSize: [20, 20]
                                })
                            }
                        ).addTo(map);
                        marker.bindPopup(`
                            <b>Proovitükk ${index + 1}</b><br>
                            Langi ${langiNumber}<br>
                            Raadius: ${proovitukk.raadius.toFixed(2)} m<br>
                            Taimi: ${proovitukk.taimeArv}<br>
                            Taimi/ha: ${proovitukk.taimedeArvHektaril.toFixed(2)}
                        `);
                        allMarkers.push(marker);
                    }
                });
            });
            
            if (allMarkers.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }

        // Peida kaart
        function varjakaart() {
            document.getElementById('map').style.display = 'none';
        }

        // Laadi andmed tekstifailina
        function laadiAndmedTxtFailina() {
            const andmed = JSON.parse(localStorage.getItem("proovitukid")) || [];
            if (andmed.length === 0) {
                alert("Pole andmeid allalaadimiseks!");
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Langi nr;Kuupäev;Raadius (m);Pindala (m²);Taimede arv;Taimi/ha;Tööaeg;Latitude;Longitude\n";
            
            andmed.forEach(item => {
                csvContent += `${item.langiNumber};${item.kuupaev};${item.raadius.toFixed(2)};${item.pindala.toFixed(2)};${item.taimeArv};${item.taimedeArvHektaril.toFixed(2)};${item.tööaeg};${item.gps.latitude};${item.gps.longitude}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "proovitükid.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Kustuta kõik andmed
        function kustutaAndmed() {
            if (confirm("Kas olete kindel, et soovite kõik andmed kustutada?")) {
                localStorage.removeItem("proovitukid");
                
                if (map) {
                    allMarkers.forEach(marker => map.removeLayer(marker));
                    allMarkers = [];
                }
                
                alert("Kõik andmed on kustutatud!");
            }
        }

        // Lehe laadimisel
        window.onload = function() {
            document.getElementById("kuupaev").value = new Date().toISOString().slice(0, 10);
            initMap();
        };
    </script>
</body>
</html>
